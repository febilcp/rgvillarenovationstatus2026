<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Villa Compound Renovation & AC Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
:root {
    --primary: #1e3a5f; --primary-light: #2d5a87; --secondary: #3498db;
    --success: #27ae60; --success-light: #2ecc71; --warning: #f39c12;
    --danger: #e74c3c; --info: #17a2b8; --half: #9b59b6; --cost: #e91e63;
    --light: #f8f9fa; --dark: #2c3e50; --gray: #6c757d; --gray-light: #e9ecef;
    --white: #ffffff; --shadow: 0 4px 15px rgba(0,0,0,0.1);
    --shadow-lg: 0 10px 40px rgba(0,0,0,0.15); --radius: 12px;
    --radius-xl: 30px; --transition: all 0.3s ease;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
html { scroll-behavior: smooth; }
body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: var(--dark); line-height: 1.6; }
.container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
.login-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; z-index: 99999; transition: opacity 0.5s ease; }
.login-overlay.hidden { opacity: 0; pointer-events: none; }
.login-box { background: var(--white); padding: 40px; border-radius: var(--radius); box-shadow: var(--shadow-lg); width: 90%; max-width: 400px; text-align: center; }
.login-box .logo-icon { width: 80px; height: 80px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 2rem; color: white; }
.login-box h2 { color: var(--primary); margin-bottom: 8px; }
.login-box p { color: var(--gray); margin-bottom: 25px; font-size: 0.9rem; }
.login-box .input-group { position: relative; margin-bottom: 20px; }
.login-box .input-group i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--gray); }
.login-box input { width: 100%; padding: 14px 14px 14px 45px; border: 2px solid var(--gray-light); border-radius: var(--radius); font-size: 1rem; font-family: inherit; }
.login-box input:focus { outline: none; border-color: var(--secondary); }
.login-box .login-btn { width: 100%; padding: 14px; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; border-radius: var(--radius); font-size: 1rem; font-weight: 600; cursor: pointer; }
.login-box .error-msg { color: var(--danger); font-size: 0.85rem; margin-top: 15px; display: none; }
.login-box .error-msg.show { display: block; }
.main-content { display: none; }
.main-content.visible { display: block; }
.header { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); padding: 15px 0; position: sticky; top: 0; z-index: 1000; box-shadow: var(--shadow); }
.header .container { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
.logo { display: flex; align-items: center; gap: 12px; }
.logo i { font-size: 2rem; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.logo-text h1 { font-size: 1.2rem; font-weight: 700; color: var(--primary); }
.logo-text span { font-size: 0.75rem; color: var(--gray); }
.header-actions { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
.header-btn { display: flex; align-items: center; gap: 6px; padding: 10px 16px; border: none; border-radius: var(--radius-xl); font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: var(--transition); font-family: inherit; }
.refresh-btn { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: var(--white); }
.export-btn { background: linear-gradient(135deg, var(--success), var(--success-light)); color: var(--white); }
.logout-btn { background: var(--gray-light); color: var(--gray); }
.tab-navigation { background: rgba(255,255,255,0.95); padding: 0; margin: 20px 0 0; border-radius: var(--radius); box-shadow: var(--shadow); display: flex; }
.tab-btn { flex: 1; padding: 16px 20px; background: transparent; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-family: inherit; font-size: 0.95rem; font-weight: 500; color: var(--gray); display: flex; align-items: center; justify-content: center; gap: 8px; transition: var(--transition); }
.tab-btn:hover { background: var(--light); }
.tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); background: rgba(52,152,219,0.05); }
.tab-content { display: none; }
.tab-content.active { display: block; }
.stats-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin: 25px 0 15px; }
.stat-card { background: rgba(255,255,255,0.95); border-radius: var(--radius); padding: 20px; display: flex; align-items: center; gap: 15px; box-shadow: var(--shadow); transition: var(--transition); border-left: 4px solid var(--secondary); cursor: pointer; }
.stat-card:hover { transform: translateY(-5px); }
.stat-icon { width: 55px; height: 55px; border-radius: var(--radius); display: flex; align-items: center; justify-content: center; font-size: 1.4rem; background: rgba(52,152,219,0.15); color: var(--secondary); }
.stat-info h3 { font-size: 1.8rem; font-weight: 700; color: var(--dark); }
.stat-info p { color: var(--gray); font-size: 0.85rem; margin-top: 4px; }
.table-wrapper { background: rgba(255,255,255,0.98); border-radius: var(--radius); box-shadow: var(--shadow); overflow-x: auto; margin: 20px 0; }
table { width: 100%; border-collapse: collapse; }
th, td { padding: 14px 16px; text-align: left; }
th { background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: var(--white); font-weight: 600; font-size: 0.85rem; }
td { border-bottom: 1px solid var(--gray-light); font-size: 0.9rem; }
.loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; z-index: 9999; }
.loading-overlay.hidden { display: none; }
.loader { text-align: center; color: white; }
.loader i { font-size: 3.5rem; animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.loader p { margin-top: 20px; font-size: 1.1rem; }
.toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--dark); color: white; padding: 15px 25px; border-radius: var(--radius); z-index: 10001; opacity: 0; transition: var(--transition); }
.toast.show { opacity: 1; }
.toast.success { background: var(--success); }
@media (max-width: 1200px) { .stats-grid { grid-template-columns: repeat(3, 1fr); } }
@media (max-width: 768px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
    </style>
</head>
<body>

<div class="login-overlay" id="loginOverlay">
    <div class="login-box">
        <div class="logo-icon"><i class="fas fa-building"></i></div>
        <h2>Villa Renovation Tracker</h2>
        <p>Enter password to access</p>
        <form id="loginForm">
            <div class="input-group">
                <i class="fas fa-lock"></i>
                <input type="password" id="passwordInput" placeholder="Enter Password" required>
            </div>
            <button type="submit" class="login-btn">Login</button>
        </form>
        <p class="error-msg" id="loginError">Incorrect password</p>
    </div>
</div>

<div class="main-content" id="mainContent">
    <header class="header">
        <div class="container">
            <div class="logo">
                <i class="fas fa-building"></i>
                <div class="logo-text">
                    <h1>Villa Compound Tracker</h1>
                    <span>Renovation & AC Management</span>
                </div>
            </div>
            <div class="header-actions">
                <button id="refreshBtn" class="header-btn refresh-btn"><i class="fas fa-sync-alt"></i> Refresh</button>
                <button onclick="exportData()" class="header-btn export-btn"><i class="fas fa-file-excel"></i> Export</button>
                <button class="header-btn logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="tab-navigation">
            <button class="tab-btn active" onclick="switchTab('renovation')">
                <i class="fas fa-tools"></i> Renovation Status
            </button>
            <button class="tab-btn" onclick="switchTab('ac')">
                <i class="fas fa-wind"></i> AC Replacement
            </button>
        </div>

        <div class="tab-content active" id="renovationTab">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-home"></i></div>
                    <div class="stat-info"><h3 id="totalVillas">0</h3><p>Total Villas</p></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                    <div class="stat-info"><h3 id="fullRenovated">0</h3><p>Full Renovated</p></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-adjust"></i></div>
                    <div class="stat-info"><h3 id="halfRenovated">0</h3><p>Half Renovated</p></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-tools"></i></div>
                    <div class="stat-info"><h3 id="inProgress">0</h3><p>Under Renovation</p></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-times-circle"></i></div>
                    <div class="stat-info"><h3 id="nonRenovated">0</h3><p>Non Renovated</p></div>
                </div>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Villa No</th>
                            <th>Status</th>
                            <th>Cost</th>
                            <th>Duration</th>
                            <th>Date</th>
                            <th>Remarks</th>
                        </tr>
                    </thead>
                    <tbody id="renovationTable"></tbody>
                </table>
            </div>
        </div>

        <div class="tab-content" id="acTab">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-wind"></i></div>
                    <div class="stat-info"><h3 id="totalACs">0</h3><p>Total ACs</p></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-home"></i></div>
                    <div class="stat-info"><h3 id="villasWithAC">0</h3><p>Villas</p></div>
                </div>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Villa</th>
                            <th>LVR</th>
                            <th>Sitting</th>
                            <th>Office</th>
                            <th>MBR 1</th>
                            <th>MBR 2</th>
                            <th>MBR 3</th>
                            <th>Kids</th>
                            <th>Guest</th>
                            <th>Kitchen</th>
                            <th>SQ</th>
                            <th>Store</th>
                            <th>Patio</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="acTable"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="loading-overlay" id="loadingOverlay">
    <div class="loader">
        <i class="fas fa-spinner"></i>
        <p>Loading data...</p>
    </div>
</div>

<div class="toast" id="toast">
    <span id="toastMessage">Success!</span>
</div>

<script>
const VALID_PASSWORD = 'villa2024';
const SHEET_ID = '1NQguf6umaBIgBmPDu3EYqQXBW6Ovo6pcoTkalDSUlnk';
const RENOVATION_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=0`;
const AC_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=1`;

let renovationData = [];
let acData = [];

document.addEventListener('DOMContentLoaded', () => {
    if (sessionStorage.getItem('villaLoggedIn') === 'true') showMainContent();
    document.getElementById('loginForm').addEventListener('submit', handleLogin);
    document.getElementById('refreshBtn').addEventListener('click', fetchAllData);
});

function handleLogin(e) {
    e.preventDefault();
    if (document.getElementById('passwordInput').value === VALID_PASSWORD) {
        sessionStorage.setItem('villaLoggedIn', 'true');
        showMainContent();
    } else {
        document.getElementById('loginError').classList.add('show');
        setTimeout(() => document.getElementById('loginError').classList.remove('show'), 3000);
    }
}

function showMainContent() {
    document.getElementById('loginOverlay').classList.add('hidden');
    document.getElementById('mainContent').classList.add('visible');
    fetchAllData();
}

function logout() {
    sessionStorage.removeItem('villaLoggedIn');
    location.reload();
}

async function fetchAllData() {
    showLoading(true);
    try {
        await Promise.all([fetchRenovationData(), fetchACData()]);
        updateRenovationView();
        updateACView();
        showToast('Data loaded successfully', 'success');
    } catch (e) {
        console.error(e);
        showToast('Error loading data', 'error');
    } finally {
        showLoading(false);
    }
}

async function fetchRenovationData() {
    try {
        const res = await fetch(RENOVATION_URL);
        const text = await res.text();
        const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
        renovationData = json.table.rows.map((row, i) => {
            const c = row.c;
            return {
                id: i,
                villaNo: getVal(c, 0),
                status: getVal(c, 1),
                dateRenovated: getVal(c, 2),
                remarks: getVal(c, 3),
                cost: parseFloat(String(getVal(c, 4)).replace(/[^0-9.-]/g, '')) || 0,
                startDate: getVal(c, 5),
                endDate: getVal(c, 6)
            };
        }).filter(r => r.villaNo && !String(r.villaNo).toLowerCase().includes('villa no'));
    } catch (e) {
        console.error('Renovation data fetch error:', e);
    }
}

async function fetchACData() {
    try {
        const res = await fetch(AC_URL);
        const text = await res.text();
        const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
        acData = json.table.rows.map((row, i) => {
            const c = row.c;
            return {
                id: i,
                villaNo: getVal(c, 0),
                lvr: parseInt(getVal(c, 1)) || 0,
                sitting: parseInt(getVal(c, 2)) || 0,
                office: parseInt(getVal(c, 3)) || 0,
                mbr1: parseInt(getVal(c, 4)) || 0,
                mbr2: parseInt(getVal(c, 5)) || 0,
                mbr3: parseInt(getVal(c, 6)) || 0,
                kids: parseInt(getVal(c, 7)) || 0,
                guest: parseInt(getVal(c, 8)) || 0,
                kitchen: parseInt(getVal(c, 9)) || 0,
                sq: parseInt(getVal(c, 10)) || 0,
                store: parseInt(getVal(c, 11)) || 0,
                patio: parseInt(getVal(c, 12)) || 0,
                total: parseInt(getVal(c, 13)) || 0
            };
        }).filter(r => r.villaNo && !String(r.villaNo).toLowerCase().includes('villa'));
    } catch (e) {
        console.error('AC data fetch error:', e);
    }
}

function getVal(cells, i) {
    if (!cells || !cells[i]) return '';
    const c = cells[i];
    return c.f || c.v || '';
}

function updateRenovationView() {
    const full = renovationData.filter(i => isFullRenovated(i.status)).length;
    const half = renovationData.filter(i => isHalfRenovated(i.status)).length;
    const prog = renovationData.filter(i => isInProgress(i.status)).length;
    const non = renovationData.filter(i => isNonRenovated(i.status)).length;
    
    document.getElementById('totalVillas').textContent = renovationData.length;
    document.getElementById('fullRenovated').textContent = full;
    document.getElementById('halfRenovated').textContent = half;
    document.getElementById('inProgress').textContent = prog;
    document.getElementById('nonRenovated').textContent = non;
    
    const tbody = document.getElementById('renovationTable');
    tbody.innerHTML = renovationData.map(i => `
        <tr>
            <td>Villa ${i.villaNo}</td>
            <td>${i.status || 'N/A'}</td>
            <td>${i.cost.toLocaleString()}</td>
            <td>${calcDuration(i.startDate, i.endDate) || '-'} days</td>
            <td>${i.dateRenovated || '-'}</td>
            <td>${i.remarks || '-'}</td>
        </tr>
    `).join('');
}

function updateACView() {
    const totalACs = acData.reduce((sum, i) => sum + i.total, 0);
    document.getElementById('totalACs').textContent = totalACs;
    document.getElementById('villasWithAC').textContent = acData.length;
    
    const tbody = document.getElementById('acTable');
    tbody.innerHTML = acData.map(i => `
        <tr>
            <td>Villa ${i.villaNo}</td>
            <td>${i.lvr}</td>
            <td>${i.sitting}</td>
            <td>${i.office}</td>
            <td>${i.mbr1}</td>
            <td>${i.mbr2}</td>
            <td>${i.mbr3}</td>
            <td>${i.kids}</td>
            <td>${i.guest}</td>
            <td>${i.kitchen}</td>
            <td>${i.sq}</td>
            <td>${i.store}</td>
            <td>${i.patio}</td>
            <td><strong>${i.total}</strong></td>
        </tr>
    `).join('');
}

function isFullRenovated(s) {
    if (!s) return false;
    const x = String(s).toLowerCase();
    return !x.includes('non') && !x.includes('half') && !x.includes('under') && (x.includes('full') || x.includes('renovated'));
}

function isHalfRenovated(s) {
    return s && String(s).toLowerCase().includes('half');
}

function isInProgress(s) {
    if (!s) return false;
    const x = String(s).toLowerCase();
    return !x.includes('half') && (x.includes('under') || x.includes('progress'));
}

function isNonRenovated(s) {
    return !isFullRenovated(s) && !isHalfRenovated(s) && !isInProgress(s);
}

function calcDuration(start, end) {
    if (!start) return null;
    const s = new Date(start);
    const e = end ? new Date(end) : new Date();
    if (isNaN(s)) return null;
    return Math.max(0, Math.ceil((e - s) / (1000 * 60 * 60 * 24)));
}

function switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    if (tab === 'renovation') {
        document.querySelectorAll('.tab-btn')[0].classList.add('active');
        document.getElementById('renovationTab').classList.add('active');
    } else {
        document.querySelectorAll('.tab-btn')[1].classList.add('active');
        document.getElementById('acTab').classList.add('active');
    }
}

function exportData() {
    const ws1 = XLSX.utils.json_to_sheet(renovationData.map(i => ({
        'Villa': i.villaNo,
        'Status': i.status,
        'Cost': i.cost,
        'Start': i.startDate,
        'End': i.endDate,
        'Remarks': i.remarks
    })));
    
    const ws2 = XLSX.utils.json_to_sheet(acData.map(i => ({
        'Villa': i.villaNo,
        'LVR': i.lvr,
        'Sitting': i.sitting,
        'Office': i.office,
        'MBR1': i.mbr1,
        'MBR2': i.mbr2,
        'MBR3': i.mbr3,
        'Kids': i.kids,
        'Guest': i.guest,
        'Kitchen': i.kitchen,
        'SQ': i.sq,
        'Store': i.store,
        'Patio': i.patio,
        'Total': i.total
    })));
    
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws1, 'Renovation');
    XLSX.utils.book_append_sheet(wb, ws2, 'AC Replacement');
    XLSX.writeFile(wb, `Villa_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
    showToast('Exported successfully', 'success');
}

function showLoading(show) {
    document.getElementById('loadingOverlay').classList.toggle('hidden', !show);
}

function showToast(msg, type = 'success') {
    const toast = document.getElementById('toast');
    document.getElementById('toastMessage').textContent = msg;
    toast.className = `toast ${type} show`;
    setTimeout(() => toast.classList.remove('show'), 3000);
}

window.switchTab = switchTab;
window.logout = logout;
window.exportData = exportData;
</script>
</body>
</html>
