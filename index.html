<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Villa Compound Renovation & AC Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
:root {
    --primary: #1e3a5f; --primary-light: #2d5a87; --secondary: #3498db;
    --success: #27ae60; --success-light: #2ecc71; --warning: #f39c12;
    --danger: #e74c3c; --info: #17a2b8; --half: #9b59b6; --cost: #e91e63;
    --light: #f8f9fa; --dark: #2c3e50; --gray: #6c757d; --gray-light: #e9ecef;
    --white: #ffffff; --shadow: 0 4px 15px rgba(0,0,0,0.1);
    --shadow-lg: 0 10px 40px rgba(0,0,0,0.15); --radius: 12px;
    --radius-xl: 30px; --transition: all 0.3s ease;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
html { scroll-behavior: smooth; }
body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: var(--dark); line-height: 1.6; }
.container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }

.login-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; z-index: 99999; transition: opacity 0.5s ease; }
.login-overlay.hidden { opacity: 0; pointer-events: none; }
.login-box { background: var(--white); padding: 40px; border-radius: var(--radius); box-shadow: var(--shadow-lg); width: 90%; max-width: 400px; text-align: center; }
.login-box .logo-icon { width: 80px; height: 80px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 2rem; color: white; }
.login-box h2 { color: var(--primary); margin-bottom: 8px; }
.login-box p { color: var(--gray); margin-bottom: 25px; font-size: 0.9rem; }
.login-box .input-group { position: relative; margin-bottom: 20px; }
.login-box .input-group i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--gray); }
.login-box input { width: 100%; padding: 14px 14px 14px 45px; border: 2px solid var(--gray-light); border-radius: var(--radius); font-size: 1rem; font-family: inherit; }
.login-box input:focus { outline: none; border-color: var(--secondary); }
.login-box .login-btn { width: 100%; padding: 14px; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; border-radius: var(--radius); font-size: 1rem; font-weight: 600; cursor: pointer; }
.login-box .error-msg { color: var(--danger); font-size: 0.85rem; margin-top: 15px; display: none; }
.login-box .error-msg.show { display: block; animation: shake 0.5s ease; }
@keyframes shake { 0%,100%{transform:translateX(0);} 25%{transform:translateX(-10px);} 75%{transform:translateX(10px);} }

.main-content { display: none; }
.main-content.visible { display: block; }

.header { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); padding: 15px 0; position: sticky; top: 0; z-index: 1000; box-shadow: var(--shadow); }
.header .container { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
.logo { display: flex; align-items: center; gap: 12px; }
.logo i { font-size: 2rem; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.logo-text h1 { font-size: 1.2rem; font-weight: 700; color: var(--primary); }
.logo-text span { font-size: 0.75rem; color: var(--gray); }
.header-actions { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
.header-btn { display: flex; align-items: center; gap: 6px; padding: 10px 16px; border: none; border-radius: var(--radius-xl); font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: var(--transition); font-family: inherit; }
.refresh-btn { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: var(--white); }
.export-btn { background: linear-gradient(135deg, var(--success), var(--success-light)); color: var(--white); }
.logout-btn { background: var(--gray-light); color: var(--gray); }
.logout-btn:hover { background: var(--danger); color: white; }
.header-btn:hover { transform: translateY(-2px); }

.tab-navigation { background: rgba(255,255,255,0.95); padding: 0; margin: 20px 0 0; border-radius: var(--radius); box-shadow: var(--shadow); display: flex; }
.tab-btn { flex: 1; padding: 16px 20px; background: transparent; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-family: inherit; font-size: 0.95rem; font-weight: 500; color: var(--gray); display: flex; align-items: center; justify-content: center; gap: 8px; transition: var(--transition); }
.tab-btn:hover { background: var(--light); }
.tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); background: rgba(52,152,219,0.05); }
.tab-content { display: none; }
.tab-content.active { display: block; animation: fadeIn 0.3s ease; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

.stats-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin: 25px 0 15px; }
@media (max-width: 1200px) { .stats-grid { grid-template-columns: repeat(3, 1fr); } }
@media (max-width: 768px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
@media (max-width: 480px) { .stats-grid { grid-template-columns: 1fr; } }

.stat-card { background: rgba(255,255,255,0.95); border-radius: var(--radius); padding: 20px; display: flex; align-items: center; gap: 15px; box-shadow: var(--shadow); transition: var(--transition); border-left: 4px solid var(--secondary); cursor: pointer; }
.stat-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
.stat-card.total { border-left-color: var(--secondary); }
.stat-card.renovated { border-left-color: var(--success); }
.stat-card.half-renovated { border-left-color: var(--half); }
.stat-card.in-progress { border-left-color: var(--warning); }
.stat-card.non-renovated { border-left-color: var(--danger); }
.stat-card.total:hover { background: rgba(52,152,219,0.1); }
.stat-card.renovated:hover { background: rgba(39,174,96,0.1); }
.stat-card.half-renovated:hover { background: rgba(155,89,182,0.1); }
.stat-card.in-progress:hover { background: rgba(243,156,18,0.1); }
.stat-card.non-renovated:hover { background: rgba(231,76,60,0.1); }

.stat-icon { width: 55px; height: 55px; border-radius: var(--radius); display: flex; align-items: center; justify-content: center; font-size: 1.4rem; }
.stat-card.total .stat-icon { background: rgba(52,152,219,0.15); color: var(--secondary); }
.stat-card.renovated .stat-icon { background: rgba(39,174,96,0.15); color: var(--success); }
.stat-card.half-renovated .stat-icon { background: rgba(155,89,182,0.15); color: var(--half); }
.stat-card.in-progress .stat-icon { background: rgba(243,156,18,0.15); color: var(--warning); }
.stat-card.non-renovated .stat-icon { background: rgba(231,76,60,0.15); color: var(--danger); }
.stat-info h3 { font-size: 1.8rem; font-weight: 700; line-height: 1; color: var(--dark); }
.stat-info p { color: var(--gray); font-size: 0.85rem; margin-top: 4px; }

.charts-section { padding: 15px 0; }
.chart-card { background: rgba(255,255,255,0.95); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); max-width: 450px; margin: 0 auto; }
.chart-card h3 { font-size: 1rem; color: var(--dark); margin-bottom: 15px; display: flex; align-items: center; gap: 10px; justify-content: center; }
.chart-card h3 i { color: var(--secondary); }
.chart-container { position: relative; height: 280px; }

.progress-section { padding: 10px 0 15px; }
.progress-card { background: rgba(255,255,255,0.95); border-radius: var(--radius); padding: 22px; box-shadow: var(--shadow); }
.progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
.progress-header h2 { font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 10px; color: var(--dark); }
.progress-header h2 i { color: var(--secondary); }
.progress-percentage { font-size: 1.6rem; font-weight: 700; color: var(--success); }
.progress-bar-container { background: var(--gray-light); border-radius: var(--radius-xl); height: 24px; overflow: hidden; display: flex; }
.progress-segment { height: 100%; transition: width 1.5s ease; }
.progress-segment.full { background: var(--success); }
.progress-segment.half { background: var(--half); }
.progress-segment.under { background: var(--warning); }
.progress-segment.non { background: var(--danger); }
.legend { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; margin-top: 15px; }
.legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.85rem; }
.legend-color { width: 14px; height: 14px; border-radius: 4px; }
.legend-color.full { background: var(--success); }
.legend-color.half { background: var(--half); }
.legend-color.under { background: var(--warning); }
.legend-color.non { background: var(--danger); }

.view-toggle-section { padding: 12px 0; }
.view-toggle { display: flex; gap: 6px; background: rgba(255,255,255,0.95); padding: 5px; border-radius: var(--radius); box-shadow: var(--shadow); width: fit-content; }
.view-btn { padding: 9px 16px; background: transparent; border: none; border-radius: 8px; font-size: 0.85rem; cursor: pointer; font-family: inherit; color: var(--gray); display: flex; align-items: center; gap: 6px; }
.view-btn:hover { background: var(--gray-light); color: var(--dark); }
.view-btn.active { background: var(--primary); color: var(--white); }
.view-content { display: none; }
.view-content.active { display: block; }

.table-wrapper { background: rgba(255,255,255,0.98); border-radius: var(--radius); box-shadow: var(--shadow); overflow-x: auto; margin: 20px 0; }
table { width: 100%; border-collapse: collapse; min-width: 900px; }
th, td { padding: 14px 16px; text-align: left; }
th { background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: var(--white); font-weight: 600; font-size: 0.85rem; text-transform: uppercase; white-space: nowrap; }
td { border-bottom: 1px solid var(--gray-light); font-size: 0.9rem; }
tbody tr { transition: var(--transition); cursor: pointer; }
tbody tr:hover { background: rgba(52,152,219,0.05); }
td:first-child { font-weight: 600; color: var(--primary); }

.status-badge { padding: 5px 12px; border-radius: var(--radius-xl); font-size: 0.75rem; font-weight: 600; text-transform: uppercase; display: inline-block; }
.status-full-renovated { background: rgba(39,174,96,0.15); color: var(--success); }
.status-half-renovated { background: rgba(155,89,182,0.15); color: var(--half); }
.status-in-progress { background: rgba(243,156,18,0.15); color: var(--warning); }
.status-non-renovated { background: rgba(231,76,60,0.15); color: var(--danger); }

.villa-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
.villa-card { background: rgba(255,255,255,0.98); border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); transition: var(--transition); cursor: pointer; }
.villa-card:hover { transform: translateY(-6px); box-shadow: var(--shadow-lg); }
.villa-card-header { padding: 18px; display: flex; justify-content: space-between; align-items: center; }
.villa-card-header.full-renovated { background: linear-gradient(135deg, var(--success), #2ecc71); color: white; }
.villa-card-header.half-renovated { background: linear-gradient(135deg, var(--half), #a855f7); color: white; }
.villa-card-header.in-progress { background: linear-gradient(135deg, var(--warning), #e67e22); color: white; }
.villa-card-header.non-renovated { background: linear-gradient(135deg, var(--danger), #c0392b); color: white; }
.villa-card-header h3 { font-size: 1.15rem; display: flex; align-items: center; gap: 8px; }
.villa-card-body { padding: 18px; }
.villa-card-body .info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed var(--gray-light); font-size: 0.9rem; }
.villa-card-body .info-row:last-child { border-bottom: none; }
.villa-card-body .label { color: var(--gray); display: flex; align-items: center; gap: 6px; }
.villa-card-body .value { font-weight: 600; color: var(--dark); }
.villa-card-body .value.cost { color: var(--cost); }

.ac-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; margin: 20px 0; }
.ac-card { background: rgba(255,255,255,0.98); border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); transition: var(--transition); }
.ac-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
.ac-card-header { padding: 18px; background: linear-gradient(135deg, var(--info), #3498db); color: white; display: flex; justify-content: space-between; align-items: center; }
.ac-card-header h3 { font-size: 1.15rem; display: flex; align-items: center; gap: 8px; }
.ac-card-body { padding: 18px; }
.ac-room-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
.ac-room-item { background: var(--light); padding: 10px; border-radius: 8px; text-align: center; }
.ac-room-item .room-name { font-size: 0.75rem; color: var(--gray); margin-bottom: 4px; text-transform: uppercase; }
.ac-room-item .room-qty { font-size: 1.2rem; font-weight: 700; color: var(--info); }
.ac-total { margin-top: 12px; padding-top: 12px; border-top: 2px solid var(--gray-light); text-align: center; }
.ac-total span { font-size: 0.85rem; color: var(--gray); }
.ac-total strong { font-size: 1.5rem; color: var(--info); margin-left: 8px; }

.loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; z-index: 9999; }
.loading-overlay.hidden { display: none; }
.loader { text-align: center; color: white; }
.loader i { font-size: 3.5rem; animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.loader p { margin-top: 20px; font-size: 1.1rem; }

.toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--dark); color: white; padding: 15px 25px; border-radius: var(--radius); z-index: 10001; opacity: 0; transition: var(--transition); }
.toast.show { opacity: 1; }
.toast.success { background: var(--success); }
.toast.error { background: var(--danger); }
    </style>
</head>
<body>

<div class="login-overlay" id="loginOverlay">
    <div class="login-box">
        <div class="logo-icon"><i class="fas fa-building"></i></div>
        <h2>Villa Renovation Tracker</h2>
        <p>Enter password to access</p>
        <form id="loginForm">
            <div class="input-group">
                <i class="fas fa-lock"></i>
                <input type="password" id="passwordInput" placeholder="Enter Password" required>
            </div>
            <button type="submit" class="login-btn">Login</button>
        </form>
        <p class="error-msg" id="loginError">Incorrect password</p>
    </div>
</div>

<div class="main-content" id="mainContent">
    <header class="header">
        <div class="container">
            <div class="logo">
                <i class="fas fa-building"></i>
                <div class="logo-text">
                    <h1>Villa Compound Tracker</h1>
                    <span>Renovation & AC Management</span>
                </div>
            </div>
            <div class="header-actions">
                <button id="refreshBtn" class="header-btn refresh-btn"><i class="fas fa-sync-alt"></i> Refresh</button>
                <button onclick="exportData()" class="header-btn export-btn"><i class="fas fa-file-excel"></i> Export</button>
                <button class="header-btn logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="tab-navigation">
            <button class="tab-btn active" onclick="switchTab('renovation')">
                <i class="fas fa-tools"></i> Renovation Status
            </button>
            <button class="tab-btn" onclick="switchTab('ac')">
                <i class="fas fa-wind"></i> AC Replacement
            </button>
        </div>

        <div class="tab-content active" id="renovationTab">
            <div class="stats-grid">
                <div class="stat-card total">
                    <div class="stat-icon"><i class="fas fa-home"></i></div>
                    <div class="stat-info"><h3 id="totalVillas">0</h3><p>Total Villas</p></div>
                </div>
                <div class="stat-card renovated">
                    <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                    <div class="stat-info"><h3 id="fullRenovated">0</h3><p>Full Renovated</p></div>
                </div>
                <div class="stat-card half-renovated">
                    <div class="stat-icon"><i class="fas fa-adjust"></i></div>
                    <div class="stat-info"><h3 id="halfRenovated">0</h3><p>Half Renovated</p></div>
                </div>
                <div class="stat-card in-progress">
                    <div class="stat-icon"><i class="fas fa-tools"></i></div>
                    <div class="stat-info"><h3 id="inProgress">0</h3><p>Under Renovation</p></div>
                </div>
                <div class="stat-card non-renovated">
                    <div class="stat-icon"><i class="fas fa-times-circle"></i></div>
                    <div class="stat-info"><h3 id="nonRenovated">0</h3><p>Non Renovated</p></div>
                </div>
            </div>

            <div class="charts-section">
                <div class="chart-card">
                    <h3><i class="fas fa-chart-pie"></i> Status Distribution</h3>
                    <div class="chart-container"><canvas id="statusChart"></canvas></div>
                </div>
            </div>

            <div class="progress-section">
                <div class="progress-card">
                    <div class="progress-header">
                        <h2><i class="fas fa-tasks"></i> Renovation Progress</h2>
                        <span class="progress-percentage" id="progressPercent">0%</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-segment full" id="progressFull" style="width:0%"></div>
                        <div class="progress-segment half" id="progressHalf" style="width:0%"></div>
                        <div class="progress-segment under" id="progressUnder" style="width:0%"></div>
                        <div class="progress-segment non" id="progressNon" style="width:0%"></div>
                    </div>
                    <div class="legend">
                        <div class="legend-item"><span class="legend-color full"></span>Full Renovated</div>
                        <div class="legend-item"><span class="legend-color half"></span>Half Renovated</div>
                        <div class="legend-item"><span class="legend-color under"></span>Under Renovation</div>
                        <div class="legend-item"><span class="legend-color non"></span>Non Renovated</div>
                    </div>
                </div>
            </div>

            <div class="view-toggle-section">
                <div class="view-toggle">
                    <button class="view-btn active" onclick="switchView('table')"><i class="fas fa-table"></i> Table</button>
                    <button class="view-btn" onclick="switchView('cards')"><i class="fas fa-th-large"></i> Cards</button>
                </div>
            </div>

            <div class="view-content active" id="tableView">
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Villa No</th>
                                <th>Status</th>
                                <th>Cost</th>
                                <th>Duration</th>
                                <th>Date</th>
                                <th>Remarks</th>
                            </tr>
                        </thead>
                        <tbody id="renovationTable"></tbody>
                    </table>
                </div>
            </div>

            <div class="view-content" id="cardsView">
                <div class="villa-cards" id="villaCards"></div>
            </div>
        </div>

        <div class="tab-content" id="acTab">
            <div class="stats-grid">
                <div class="stat-card total">
                    <div class="stat-icon"><i class="fas fa-wind"></i></div>
                    <div class="stat-info"><h3 id="totalACs">0</h3><p>Total ACs</p></div>
                </div>
                <div class="stat-card renovated">
                    <div class="stat-icon"><i class="fas fa-home"></i></div>
                    <div class="stat-info"><h3 id="villasWithAC">0</h3><p>Villas</p></div>
                </div>
            </div>

            <div class="view-toggle-section">
                <div class="view-toggle">
                    <button class="view-btn active" onclick="switchACView('table')"><i class="fas fa-table"></i> Table</button>
                    <button class="view-btn" onclick="switchACView('cards')"><i class="fas fa-th-large"></i> Cards</button>
                </div>
            </div>

            <div class="view-content active" id="acTableView">
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Villa</th>
                                <th>LVR</th>
                                <th>Sitting</th>
                                <th>Office</th>
                                <th>MBR 1</th>
                                <th>MBR 2</th>
                                <th>MBR 3</th>
                                <th>Kids</th>
                                <th>Guest</th>
                                <th>Kitchen</th>
                                <th>SQ</th>
                                <th>Store</th>
                                <th>Patio</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody id="acTable"></tbody>
                    </table>
                </div>
            </div>

            <div class="view-content" id="acCardsView">
                <div class="ac-cards" id="acCards"></div>
            </div>
        </div>
    </div>
</div>

<div class="loading-overlay" id="loadingOverlay">
    <div class="loader">
        <i class="fas fa-spinner"></i>
        <p>Loading data...</p>
    </div>
</div>

<div class="toast" id="toast">
    <span id="toastMessage">Success!</span>
</div>

<script>
const VALID_PASSWORD = 'villa2024';
const SHEET_ID = '1NQguf6umaBIgBmPDu3EYqQXBW6Ovo6pcoTkalDSUlnk';
const RENOVATION_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=0`;
const AC_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=1`;

let renovationData = [];
let acData = [];
let statusChart = null;

document.addEventListener('DOMContentLoaded', () => {
    if (sessionStorage.getItem('villaLoggedIn') === 'true') showMainContent();
    document.getElementById('loginForm').addEventListener('submit', handleLogin);
    document.getElementById('refreshBtn').addEventListener('click', fetchAllData);
});

function handleLogin(e) {
    e.preventDefault();
    if (document.getElementById('passwordInput').value === VALID_PASSWORD) {
        sessionStorage.setItem('villaLoggedIn', 'true');
        showMainContent();
    } else {
        document.getElementById('loginError').classList.add('show');
        setTimeout(() => document.getElementById('loginError').classList.remove('show'), 3000);
    }
}

function showMainContent() {
    document.getElementById('loginOverlay').classList.add('hidden');
    document.getElementById('mainContent').classList.add('visible');
    fetchAllData();
}

function logout() {
    sessionStorage.removeItem('villaLoggedIn');
    location.reload();
}

async function fetchAllData() {
    showLoading(true);
    try {
        await Promise.all([fetchRenovationData(), fetchACData()]);
        updateRenovationView();
        updateACView();
        showToast('Data loaded successfully', 'success');
    } catch (e) {
        console.error(e);
        showToast('Error loading data', 'error');
    } finally {
        showLoading(false);
    }
}

async function fetchRenovationData() {
    try {
        const res = await fetch(RENOVATION_URL);
        const text = await res.text();
        const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
        renovationData = json.table.rows.map((row, i) => {
            const c = row.c;
            return {
                id: i,
                villaNo: getVal(c, 0),
                status: getVal(c, 1),
                dateRenovated: getVal(c, 2),
                remarks: getVal(c, 3),
                cost: parseFloat(String(getVal(c, 4)).replace(/[^0-9.-]/g, '')) || 0,
                startDate: getVal(c, 5),
                endDate: getVal(c, 6)
            };
        }).filter(r => r.villaNo && !String(r.villaNo).toLowerCase().includes('villa no'));
    } catch (e) {
        console.error('Renovation data fetch error:', e);
    }
}

async function fetchACData() {
    try {
        const res = await fetch(AC_URL);
        const text = await res.text();
        const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
        acData = json.table.rows.map((row, i) => {
            const c = row.c;
            return {
                id: i,
                villaNo: getVal(c, 0),
                lvr: parseInt(getVal(c, 1)) || 0,
                sitting: parseInt(getVal(c, 2)) || 0,
                office: parseInt(getVal(c, 3)) || 0,
                mbr1: parseInt(getVal(c, 4)) || 0,
                mbr2: parseInt(getVal(c, 5)) || 0,
                mbr3: parseInt(getVal(c, 6)) || 0,
                kids: parseInt(getVal(c, 7)) || 0,
                guest: parseInt(getVal(c, 8)) || 0,
                kitchen: parseInt(getVal(c, 9)) || 0,
                sq: parseInt(getVal(c, 10)) || 0,
                store: parseInt(getVal(c, 11)) || 0,
                patio: parseInt(getVal(c, 12)) || 0,
                total: parseInt(getVal(c, 13)) || 0
            };
        }).filter(r => r.villaNo && !String(r.villaNo).toLowerCase().includes('villa'));
    } catch (e) {
        console.error('AC data fetch error:', e);
    }
}

function getVal(cells, i) {
    if (!cells || !cells[i]) return '';
    const c = cells[i];
    return c.f || c.v || '';
}

function updateRenovationView() {
    const full = renovationData.filter(i => isFullRenovated(i.status)).length;
    const half = renovationData.filter(i => isHalfRenovated(i.status)).length;
    const prog = renovationData.filter(i => isInProgress(i.status)).length;
    const non = renovationData.filter(i => isNonRenovated(i.status)).length;
    const pct = renovationData.length > 0 ? Math.round(((full + half * 0.5) / renovationData.length) * 100) : 0;
    
    document.getElementById('totalVillas').textContent = renovationData.length;
    document.getElementById('fullRenovated').textContent = full;
    document.getElementById('halfRenovated').textContent = half;
    document.getElementById('inProgress').textContent = prog;
    document.getElementById('nonRenovated').textContent = non;
    document.getElementById('progressPercent').textContent = pct + '%';
    
    setTimeout(() => {
        const t = renovationData.length;
        document.getElementById('progressFull').style.width = (t > 0 ? full / t * 100 : 0) + '%';
        document.getElementById('progressHalf').style.width = (t > 0 ? half / t * 100 : 0) + '%';
        document.getElementById('progressUnder').style.width = (t > 0 ? prog / t * 100 : 0) + '%';
        document.getElementById('progressNon').style.width = (t > 0 ? non / t * 100 : 0) + '%';
    }, 300);
    
    updateChart(full, half, prog, non);
    renderRenovationTable();
    renderRenovationCards();
}

function updateChart(full, half, prog, non) {
    if (statusChart) statusChart.destroy();
    statusChart = new Chart(document.getElementById('statusChart'), {
        type: 'doughnut',
        data: {
            labels: ['Full Renovated', 'Half Renovated', 'Under Renovation', 'Non Renovated'],
            datasets: [{
                data: [full, half, prog, non],
                backgroundColor: ['#27ae60', '#9b59b6', '#f39c12', '#e74c3c'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { padding: 20, usePointStyle: true }
                }
            }
        }
    });
}

function renderRenovationTable() {
    const tbody = document.getElementById('renovationTable');
    tbody.innerHTML = renovationData.map(i => `
        <tr>
            <td>Villa ${i.villaNo}</td>
            <td><span class="status-badge ${getStatusClass(i.status)}">${i.status || 'N/A'}</span></td>
            <td style="color: var(--cost); font-weight: 600;">${i.cost.toLocaleString()}</td>
            <td>${calcDuration(i.startDate, i.endDate) || '-'} days</td>
            <td>${i.dateRenovated || '-'}</td>
            <td>${i.remarks || '-'}</td>
        </tr>
    `).join('');
}

function renderRenovationCards() {
    const cards = document.getElementById('villaCards');
    cards.innerHTML = renovationData.map(i => {
        const dur = calcDuration(i.startDate, i.endDate);
        return `<div class="villa-card">
            <div class="villa-card-header ${getHeaderClass(i.status)}">
                <h3><i class="fas fa-home"></i> Villa ${i.villaNo}</h3>
            </div>
            <div class="villa-card-body">
                <div class="info-row">
                    <span class="label"><i class="fas fa-info-circle"></i> Status</span>
                    <span class="value">${i.status || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="label"><i class="fas fa-coins"></i> Cost</span>
                    <span class="value cost">${i.cost.toLocaleString()}</span>
                </div>
                <div class="info-row">
                    <span class="label"><i class="fas fa-clock"></i> Duration</span>
                    <span class="value">${dur !== null ? dur + ' days' : '-'}</span>
                </div>
                <div class="info-row">
                    <span class="label"><i class="fas fa-calendar"></i> Date</span>
                    <span class="value">${i.dateRenovated || '-'}</span>
                </div>
            </div>
        </div>`;
    }).join('');
}

function updateACView() {
    const totalACs = acData.reduce((sum, i) => sum + i.total, 0);
    document.getElementById('totalACs').textContent = totalACs;
    document.getElementById('villasWithAC').textContent = acData.length;
    
    renderACTable();
    renderACCards();
}

function renderACTable() {
    const tbody = document.getElementById('acTable');
    tbody.innerHTML = acData.map(i => `
        <tr>
            <td>Villa ${i.villaNo}</td>
            <td style="text-align:center">${i.lvr}</td>
            <td style="text-align:center">${i.sitting}</td>
            <td style="text-align:center">${i.office}</td>
            <td style="text-align:center">${i.mbr1}</td>
            <td style="text-align:center">${i.mbr2}</td>
            <td style="text-align:center">${i.mbr3}</td>
            <td style="text-align:center">${i.kids}</td>
            <td style="text-align:center">${i.guest}</td>
            <td style="text-align:center">${i.kitchen}</td>
            <td style="text-align:center">${i.sq}</td>
            <td style="text-align:center">${i.store}</td>
            <td style="text-align:center">${i.patio}</td>
            <td style="text-align:center; font-weight:700; color:var(--info)">${i.total}</td>
        </tr>
    `).join('');
}

function renderACCards() {
    const cards = document.getElementById('acCards');
    cards.innerHTML = acData.map(i => `
        <div class="ac-card">
            <div class="ac-card-header">
                <h3><i class="fas fa-wind"></i> Villa ${i.villaNo}</h3>
            </div>
            <div class="ac-card-body">
                <div class="ac-room-grid">
                    <div class="ac-room-item"><div class="room-name">LVR</div><div class="room-qty">${i.lvr}</div></div>
                    <div class="ac-room-item"><div class="room-name">Sitting</div><div class="room-qty">${i.sitting}</div></div>
                    <div class="ac-room-item"><div class="room-name">Office</div><div class="room-qty">${i.office}</div></div>
                    <div class="ac-room-item"><div class="room-name">MBR 1</div><div class="room-qty">${i.mbr1}</div></div>
                    <div class="ac-room-item"><div class="room-name">MBR 2</div><div class="room-qty">${i.mbr2}</div></div>
                    <div class="ac-room-item"><div class="room-name">MBR 3</div><div class="room-qty">${i.mbr3}</div></div>
                    <div class="ac-room-item"><div class="room-name">Kids</div><div class="room-qty">${i.kids}</div></div>
                    <div class="ac-room-item"><div class="room-name">Guest</div><div class="room-qty">${i.guest}</div></div>
                    <div class="ac-room-item"><div class="room-name">Kitchen</div><div class="room-qty">${i.kitchen}</div></div>
                    <div class="ac-room-item"><div class="room-name">SQ</div><div class="room-qty">${i.sq}</div></div>
                    <div class="ac-room-item"><div class="room-name">Store</div><div class="room-qty">${i.store}</div></div>
                    <div class="ac-room-item"><div class="room-name">Patio</div><div class="room-qty">${i.patio}</div></div>
                </div>
                <div class="ac-total">
                    <span>Total ACs:</span><strong>${i.total}</strong>
                </div>
            </div>
        </div>
    `).join('');
}

function isFullRenovated(s) {
    if (!s) return false;
    const x = String(s).toLowerCase();
    return !x.includes('non') && !x.includes('half') && !x.includes('under') && (x.includes('full') || x.includes('renovated'));
}

function isHalfRenovated(s) {
    return s && String(s).toLowerCase().includes('half');
}

function isInProgress(s) {
    if (!s) return false;
    const x = String(s).toLowerCase();
    return !x.includes('half') && (x.includes('under') || x.includes('progress'));
}

function isNonRenovated(s) {
    return !isFullRenovated(s) && !isHalfRenovated(s) && !isInProgress(s);
}

function getStatusClass(s) {
    if (isHalfRenovated(s)) return 'status-half-renovated';
    if (isInProgress(s)) return 'status-in-progress';
    if (isFullRenovated(s)) return 'status-full-renovated';
    return 'status-non-renovated';
}

function getHeaderClass(s) {
    if (isHalfRenovated(s)) return 'half-renovated';
    if (isInProgress(s)) return 'in-progress';
    if (isFullRenovated(s)) return 'full-renovated';
    return 'non-renovated';
}

function calcDuration(start, end) {
    if (!start) return null;
    const s = new Date(start);
    const e = end ? new Date(end) : new Date();
    if (isNaN(s)) return null;
    return Math.max(0, Math.ceil((e - s) / (1000 * 60 * 60 * 24)));
}

function switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    if (tab === 'renovation') {
        document.querySelectorAll('.tab-btn')[0].classList.add('active');
        document.getElementById('renovationTab').classList.add('active');
    } else {
        document.querySelectorAll('.tab-btn')[1].classList.add('active');
        document.getElementById('acTab').classList.add('active');
    }
}

function switchView(view) {
    const btns = document.querySelectorAll('#renovationTab .view-btn');
    btns.forEach(b => b.classList.remove('active'));
    document.getElementById('tableView').classList.remove('active');
    document.getElementById('cardsView').classList.remove('active');
    
    if (view === 'table') {
        btns[0].classList.add('active');
        document.getElementById('tableView').classList.add('active');
    } else {
        btns[1].classList.add('active');
        document.getElementById('cardsView').classList.add('active');
    }
}

function switchACView(view) {
    const btns = document.querySelectorAll('#acTab .view-btn');
    btns.forEach(b => b.classList.remove('active'));
    document.getElementById('acTableView').classList.remove('active');
    document.getElementById('acCardsView').classList.remove('active');
    
    if (view === 'table') {
        btns[0].classList.add('active');
        document.getElementById('acTableView').classList.add('active');
    } else {
        btns[1].classList.add('active');
        document.getElementById('acCardsView').classList.add('active');
    }
}

function exportData() {
    const ws1 = XLSX.utils.json_to_sheet(renovationData.map(i => ({
        'Villa': i.villaNo,
        'Status': i.status,
        'Cost': i.cost,
        'Start': i.startDate,
        'End': i.endDate,
        'Remarks': i.remarks
    })));
    
    const ws2 = XLSX.utils.json_to_sheet(acData.map(i => ({
        'Villa': i.villaNo,
        'LVR': i.lvr,
        'Sitting': i.sitting,
        'Office': i.office,
        'MBR1': i.mbr1,
        'MBR2': i.mbr2,
        'MBR3': i.mbr3,
        'Kids': i.kids,
        'Guest': i.guest,
        'Kitchen': i.kitchen,
        'SQ': i.sq,
        'Store': i.store,
        'Patio': i.patio,
        'Total': i.total
    })));
    
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws1, 'Renovation');
    XLSX.utils.book_append_sheet(wb, ws2, 'AC Replacement');
    XLSX.writeFile(wb, `Villa_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
    showToast('Exported successfully', 'success');
}

function showLoading(show) {
    document.getElementById('loadingOverlay').classList.toggle('hidden', !show);
}

function showToast(msg, type = 'success') {
    const toast = document.getElementById('toast');
    document.getElementById('toastMessage').textContent = msg;
    toast.className = `toast ${type} show`;
    setTimeout(() => toast.classList.remove('show'), 3000);
}

window.switchTab = switchTab;
window.switchView = switchView;
window.switchACView = switchACView;
window.logout = logout;
window.exportData = exportData;
</script>
</body>
</html>
