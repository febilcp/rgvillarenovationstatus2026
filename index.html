<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Villa Compound Renovation & AC Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
:root {
    --primary: #1e3a5f; --primary-light: #2d5a87; --secondary: #3498db;
    --success: #27ae60; --success-light: #2ecc71; --warning: #f39c12;
    --danger: #e74c3c; --info: #17a2b8; --half: #9b59b6; --cost: #e91e63;
    --light: #f8f9fa; --dark: #2c3e50; --gray: #6c757d; --gray-light: #e9ecef;
    --white: #ffffff; --shadow: 0 4px 15px rgba(0,0,0,0.1);
    --shadow-lg: 0 10px 40px rgba(0,0,0,0.15); --radius: 12px;
    --radius-xl: 30px; --transition: all 0.3s ease;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
html { scroll-behavior: smooth; }
body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: var(--dark); line-height: 1.6; }
.container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }

/* Print Styles */
@media print {
    .header-actions, .tab-navigation, .view-toggle-section, .stats-grid, .login-overlay, .loading-overlay, .toast, .header-btn { display: none !important; }
    .header { position: static; box-shadow: none; background: none; padding: 0; }
    .container { max-width: 100%; padding: 0; }
    body { background: white; color: black; -webkit-print-color-adjust: exact; }
    .table-wrapper { box-shadow: none; overflow: visible; }
    table { min-width: 100%; font-size: 10px; }
    .villa-card, .ac-card { border: 1px solid #ccc; box-shadow: none; break-inside: avoid; page-break-inside: avoid; }
    /* Show filtered rows in print */
    tr, .villa-card, .ac-card { display: table-row !important; display: flex !important; } 
}

.login-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; z-index: 99999; transition: opacity 0.5s ease; }
.login-overlay.hidden { opacity: 0; pointer-events: none; }
.login-box { background: var(--white); padding: 40px; border-radius: var(--radius); box-shadow: var(--shadow-lg); width: 90%; max-width: 400px; text-align: center; }
.login-box .logo-icon { width: 80px; height: 80px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 2rem; color: white; }
.login-box h2 { color: var(--primary); margin-bottom: 8px; }
.login-box p { color: var(--gray); margin-bottom: 25px; font-size: 0.9rem; }
.login-box .input-group { position: relative; margin-bottom: 20px; }
.login-box .input-group i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--gray); }
.login-box input { width: 100%; padding: 14px 14px 14px 45px; border: 2px solid var(--gray-light); border-radius: var(--radius); font-size: 1rem; font-family: inherit; }
.login-box input:focus { outline: none; border-color: var(--secondary); }
.login-box .login-btn { width: 100%; padding: 14px; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; border-radius: var(--radius); font-size: 1rem; font-weight: 600; cursor: pointer; }
.login-box .error-msg { color: var(--danger); font-size: 0.85rem; margin-top: 15px; display: none; }
.login-box .error-msg.show { display: block; animation: shake 0.5s ease; }
@keyframes shake { 0%,100%{transform:translateX(0);} 25%{transform:translateX(-10px);} 75%{transform:translateX(10px);} }

.main-content { display: none; }
.main-content.visible { display: block; }

.header { background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); padding: 15px 0; position: sticky; top: 0; z-index: 1000; box-shadow: var(--shadow); }
.header .container { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
.logo { display: flex; align-items: center; gap: 12px; }
.logo i { font-size: 2rem; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.logo-text h1 { font-size: 1.2rem; font-weight: 700; color: var(--primary); }
.logo-text span { font-size: 0.75rem; color: var(--gray); }
.header-actions { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }

/* Search Bar Style */
.search-container { position: relative; display: flex; align-items: center; }
.search-container i { position: absolute; left: 14px; color: var(--gray); }
#searchInput { padding: 9px 14px 9px 36px; border: 1px solid var(--gray-light); border-radius: var(--radius-xl); font-size: 0.85rem; font-family: inherit; width: 180px; transition: var(--transition); outline: none; }
#searchInput:focus { border-color: var(--secondary); width: 220px; }

.header-btn { display: flex; align-items: center; gap: 6px; padding: 10px 16px; border: none; border-radius: var(--radius-xl); font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: var(--transition); font-family: inherit; }
.refresh-btn { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: var(--white); }
.sheet-btn { background: linear-gradient(135deg, #e67e22, #f39c12); color: var(--white); }
.export-btn { background: linear-gradient(135deg, var(--success), var(--success-light)); color: var(--white); }
.logout-btn { background: var(--gray-light); color: var(--gray); }
.logout-btn:hover { background: var(--danger); color: white; }
.header-btn:hover { transform: translateY(-2px); }

.tab-navigation { background: rgba(255,255,255,0.95); padding: 0; margin: 20px 0 0; border-radius: var(--radius); box-shadow: var(--shadow); display: flex; }
.tab-btn { flex: 1; padding: 16px 20px; background: transparent; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-family: inherit; font-size: 0.95rem; font-weight: 500; color: var(--gray); display: flex; align-items: center; justify-content: center; gap: 8px; transition: var(--transition); }
.tab-btn:hover { background: var(--light); }
.tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); background: rgba(52,152,219,0.05); }
.tab-content { display: none; }
.tab-content.active { display: block; animation: fadeIn 0.3s ease; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* Renovation Stats */
.stats-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin: 20px 0; }
@media (max-width: 1200px) { .stats-grid { grid-template-columns: repeat(3, 1fr); } }
@media (max-width: 768px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
@media (max-width: 480px) { .stats-grid { grid-template-columns: 1fr; } }

.stat-card { background: rgba(255,255,255,0.95); border-radius: var(--radius); padding: 20px; display: flex; align-items: center; gap: 15px; box-shadow: var(--shadow); transition: var(--transition); border-left: 4px solid var(--secondary); cursor: pointer; position: relative; overflow: hidden; }
.stat-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
.stat-card.active-filter::after { content: "\f00c"; font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; right: 10px; top: 10px; font-size: 1.2rem; opacity: 0.2; color: var(--dark); }
.stat-card.total { border-left-color: var(--secondary); }
.stat-card.renovated { border-left-color: var(--success); }
.stat-card.half-renovated { border-left-color: var(--half); }
.stat-card.in-progress { border-left-color: var(--warning); }
.stat-card.non-renovated { border-left-color: var(--danger); }
.stat-card.new-ac { border-left-color: var(--success); }
.stat-card.old-ac { border-left-color: var(--warning); }

.stat-icon { width: 55px; height: 55px; border-radius: var(--radius); display: flex; align-items: center; justify-content: center; font-size: 1.4rem; }
.stat-card.total .stat-icon { background: rgba(52,152,219,0.15); color: var(--secondary); }
.stat-card.renovated .stat-icon { background: rgba(39,174,96,0.15); color: var(--success); }
.stat-card.half-renovated .stat-icon { background: rgba(155,89,182,0.15); color: var(--half); }
.stat-card.in-progress .stat-icon { background: rgba(243,156,18,0.15); color: var(--warning); }
.stat-card.non-renovated .stat-icon { background: rgba(231,76,60,0.15); color: var(--danger); }
.stat-card.new-ac .stat-icon { background: rgba(39,174,96,0.15); color: var(--success); }
.stat-card.old-ac .stat-icon { background: rgba(243,156,18,0.15); color: var(--warning); }
.stat-info h3 { font-size: 1.8rem; font-weight: 700; line-height: 1; color: var(--dark); }
.stat-info p { color: var(--gray); font-size: 0.85rem; margin-top: 4px; }

.view-toggle-section { padding: 12px 0; }
.view-toggle { display: flex; gap: 6px; background: rgba(255,255,255,0.95); padding: 5px; border-radius: var(--radius); box-shadow: var(--shadow); width: fit-content; }
.view-btn { padding: 9px 16px; background: transparent; border: none; border-radius: 8px; font-size: 0.85rem; cursor: pointer; font-family: inherit; color: var(--gray); display: flex; align-items: center; gap: 6px; }
.view-btn:hover { background: var(--gray-light); color: var(--dark); }
.view-btn.active { background: var(--primary); color: var(--white); }
.view-content { display: none; }
.view-content.active { display: block; }

.table-wrapper { background: rgba(255,255,255,0.98); border-radius: var(--radius); box-shadow: var(--shadow); overflow-x: auto; margin: 20px 0; }
table { width: 100%; border-collapse: collapse; min-width: 900px; }
th, td { padding: 14px 16px; text-align: left; }
th { background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: var(--white); font-weight: 600; font-size: 0.85rem; text-transform: uppercase; white-space: nowrap; }
td { border-bottom: 1px solid var(--gray-light); font-size: 0.9rem; }
tbody tr { transition: var(--transition); cursor: pointer; }
tbody tr:hover { background: rgba(52,152,219,0.05); }
td:first-child { font-weight: 600; color: var(--primary); }

.status-badge { padding: 5px 12px; border-radius: var(--radius-xl); font-size: 0.75rem; font-weight: 600; text-transform: uppercase; display: inline-block; }
.status-full-renovated { background: rgba(39,174,96,0.15); color: var(--success); }
.status-half-renovated { background: rgba(155,89,182,0.15); color: var(--half); }
.status-in-progress { background: rgba(243,156,18,0.15); color: var(--warning); }
.status-non-renovated { background: rgba(231,76,60,0.15); color: var(--danger); }

.ac-badge-new { font-weight: 700; color: var(--success); text-transform: uppercase; }
.ac-badge-old { font-weight: 700; color: var(--warning); text-transform: uppercase; }

.villa-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin: 20px 0; }
.villa-card { background: rgba(255,255,255,0.98); border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); transition: var(--transition); cursor: pointer; }
.villa-card:hover { transform: translateY(-6px); box-shadow: var(--shadow-lg); }
.villa-card-header { padding: 18px; display: flex; justify-content: space-between; align-items: center; }
.villa-card-header.full-renovated { background: linear-gradient(135deg, var(--success), #2ecc71); color: white; }
.villa-card-header.half-renovated { background: linear-gradient(135deg, var(--half), #a855f7); color: white; }
.villa-card-header.in-progress { background: linear-gradient(135deg, var(--warning), #e67e22); color: white; }
.villa-card-header.non-renovated { background: linear-gradient(135deg, var(--danger), #c0392b); color: white; }
.villa-card-header h3 { font-size: 1.15rem; display: flex; align-items: center; gap: 8px; }
.villa-card-body { padding: 18px; }
.villa-card-body .info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed var(--gray-light); font-size: 0.9rem; }
.villa-card-body .info-row:last-child { border-bottom: none; }
.villa-card-body .label { color: var(--gray); display: flex; align-items: center; gap: 6px; }
.villa-card-body .value { font-weight: 600; color: var(--dark); }
.villa-card-body .value.cost { color: var(--cost); }

.ac-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; margin: 20px 0; }
.ac-card { background: rgba(255,255,255,0.98); border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); transition: var(--transition); }
.ac-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
.ac-card-header { padding: 18px; background: linear-gradient(135deg, var(--info), #3498db); color: white; display: flex; justify-content: space-between; align-items: center; }
.ac-card-header h3 { font-size: 1.15rem; display: flex; align-items: center; gap: 8px; }
.ac-card-body { padding: 18px; }
.ac-room-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
.ac-room-item { background: var(--light); padding: 10px; border-radius: 8px; text-align: center; min-height: 60px; display: flex; flex-direction: column; justify-content: center; align-items: center;}
.ac-room-item .room-name { font-size: 0.7rem; color: var(--gray); margin-bottom: 4px; text-transform: uppercase; }
.ac-room-item .room-qty { font-size: 0.85rem; font-weight: 700; text-transform: uppercase; }

.loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; z-index: 9999; }
.loading-overlay.hidden { display: none; }
.loader { text-align: center; color: white; }
.loader i { font-size: 3.5rem; animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.loader p { margin-top: 20px; font-size: 1.1rem; }

.toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--dark); color: white; padding: 15px 25px; border-radius: var(--radius); z-index: 10001; opacity: 0; transition: var(--transition); }
.toast.show { opacity: 1; }
.toast.success { background: var(--success); }
.toast.error { background: var(--danger); }
    </style>
</head>
<body>

<div class="login-overlay" id="loginOverlay">
    <div class="login-box">
        <div class="logo-icon"><i class="fas fa-building"></i></div>
        <h2>Villa Renovation Tracker</h2>
        <p>Enter password to access</p>
        <form id="loginForm">
            <div class="input-group">
                <i class="fas fa-lock"></i>
                <input type="password" id="passwordInput" placeholder="Enter Password" required>
            </div>
            <button type="submit" class="login-btn">Login</button>
        </form>
        <p class="error-msg" id="loginError">Incorrect password</p>
    </div>
</div>

<div class="main-content" id="mainContent">
    <header class="header">
        <div class="container">
            <div class="logo">
                <i class="fas fa-building"></i>
                <div class="logo-text">
                    <h1>Villa Compound Tracker</h1>
                    <span>Renovation & AC Management</span>
                </div>
            </div>
            <div class="header-actions">
                <!-- Search Bar -->
                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Search Villa..." onkeyup="handleSearch()">
                </div>
                
                <!-- Open Sheet Button -->
                <button onclick="openSheet()" class="header-btn sheet-btn"><i class="fas fa-table"></i> Open Sheet</button>
                
                <button id="refreshBtn" class="header-btn refresh-btn"><i class="fas fa-sync-alt"></i> Refresh</button>
                <button onclick="exportData()" class="header-btn export-btn"><i class="fas fa-file-excel"></i> Export</button>
                <button class="header-btn logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="tab-navigation">
            <button class="tab-btn active" onclick="switchTab('renovation')">
                <i class="fas fa-tools"></i> Renovation Status
            </button>
            <button class="tab-btn" onclick="switchTab('ac')">
                <i class="fas fa-wind"></i> AC Replacement
            </button>
        </div>

        <!-- RENOVATION TAB -->
        <div class="tab-content active" id="renovationTab">
            <!-- Dashboard Stats - Always Visible & Clickable -->
            <div class="stats-grid">
                <div class="stat-card total" onclick="filterRenovation('all')" title="Show All">
                    <div class="stat-icon"><i class="fas fa-home"></i></div>
                    <div class="stat-info"><h3 id="totalVillas">0</h3><p>Total Villas</p></div>
                </div>
                <div class="stat-card renovated" onclick="filterRenovation('full')" title="Show Full Renovated">
                    <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                    <div class="stat-info"><h3 id="fullRenovated">0</h3><p>Full Renovated</p></div>
                </div>
                <div class="stat-card half-renovated" onclick="filterRenovation('half')" title="Show Half Renovated">
                    <div class="stat-icon"><i class="fas fa-adjust"></i></div>
                    <div class="stat-info"><h3 id="halfRenovated">0</h3><p>Half Renovated</p></div>
                </div>
                <div class="stat-card in-progress" onclick="filterRenovation('progress')" title="Show Under Renovation">
                    <div class="stat-icon"><i class="fas fa-tools"></i></div>
                    <div class="stat-info"><h3 id="inProgress">0</h3><p>Under Renovation</p></div>
                </div>
                <div class="stat-card non-renovated" onclick="filterRenovation('non')" title="Show Non Renovated">
                    <div class="stat-icon"><i class="fas fa-times-circle"></i></div>
                    <div class="stat-info"><h3 id="nonRenovated">0</h3><p>Non Renovated</p></div>
                </div>
            </div>

            <!-- Progress Section Removed as per request -->

            <div class="view-toggle-section">
                <div class="view-toggle">
                    <button class="view-btn active" onclick="switchView('table')"><i class="fas fa-table"></i> Table</button>
                    <button class="view-btn" onclick="switchView('cards')"><i class="fas fa-th-large"></i> Cards</button>
                </div>
            </div>

            <div class="view-content active" id="tableView">
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Villa No</th>
                                <th>Status</th>
                                <th>Cost</th>
                                <th>Duration</th>
                                <th>Date</th>
                                <th>Remarks</th>
                            </tr>
                        </thead>
                        <tbody id="renovationTable"></tbody>
                    </table>
                </div>
            </div>

            <div class="view-content" id="cardsView">
                <div class="villa-cards" id="villaCards"></div>
            </div>
        </div>

        <!-- AC REPLACEMENT TAB -->
        <div class="tab-content" id="acTab">
            <!-- Dashboard AC Stats - Now Clickable Filters -->
            <div class="stats-grid">
                <div class="stat-card total" onclick="filterAC('all')" title="Show All">
                    <div class="stat-icon"><i class="fas fa-wind"></i></div>
                    <div class="stat-info"><h3 id="totalACs">0</h3><p>Total ACs</p></div>
                </div>
                <div class="stat-card renovated new-ac" onclick="filterAC('new')" title="Show Villas with New ACs">
                    <div class="stat-icon"><i class="fas fa-plus-circle"></i></div>
                    <div class="stat-info"><h3 id="totalNewACs">0</h3><p>New ACs</p></div>
                </div>
                <div class="stat-card in-progress old-ac" onclick="filterAC('old')" title="Show Villas with Old ACs">
                    <div class="stat-icon"><i class="fas fa-history"></i></div>
                    <div class="stat-info"><h3 id="totalOldACs">0</h3><p>Old ACs</p></div>
                </div>
                <div class="stat-card non-renovated" onclick="filterAC('all')">
                    <div class="stat-icon"><i class="fas fa-home"></i></div>
                    <div class="stat-info"><h3 id="villasWithAC">0</h3><p>Villas</p></div>
                </div>
            </div>

            <div class="view-toggle-section">
                <div class="view-toggle">
                    <button class="view-btn active" onclick="switchACView('table')"><i class="fas fa-table"></i> Table</button>
                    <button class="view-btn" onclick="switchACView('cards')"><i class="fas fa-th-large"></i> Cards</button>
                </div>
            </div>

            <div class="view-content active" id="acTableView">
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Villa</th>
                                <th>LVR</th>
                                <th>Sitting</th>
                                <th>Office</th>
                                <th>MBR 1</th>
                                <th>MBR 2</th>
                                <th>MBR 3</th>
                                <th>Kids</th>
                                <th>Guest</th>
                                <th>Kitchen</th>
                                <th>SQ</th>
                                <th>Store</th>
                                <th>Patio</th>
                            </tr>
                        </thead>
                        <tbody id="acTable"></tbody>
                    </table>
                </div>
            </div>

            <div class="view-content" id="acCardsView">
                <div class="ac-cards" id="acCards"></div>
            </div>
        </div>
    </div>
</div>

<div class="loading-overlay" id="loadingOverlay">
    <div class="loader">
        <i class="fas fa-spinner"></i>
        <p>Loading data...</p>
    </div>
</div>

<div class="toast" id="toast">
    <span id="toastMessage">Success!</span>
</div>

<script>
const VALID_PASSWORD = 'villa2024';
const SHEET_ID = '1NQguf6umaBIgBmPDu3EYqQXBW6Ovo6pcoTkalDSUlnk';
// RENOVATION URL uses gid=0 (Sheet 1)
const RENOVATION_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=0`;
// AC URL uses custom GID provided by user
const AC_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=7537460`;

let renovationData = [];
let acData = [];
let currentFilter = 'all'; // 'all', 'full', 'half', 'progress', 'non'
let currentACFilter = 'all'; // 'all', 'new', 'old'

document.addEventListener('DOMContentLoaded', () => {
    if (sessionStorage.getItem('villaLoggedIn') === 'true') showMainContent();
    document.getElementById('loginForm').addEventListener('submit', handleLogin);
    document.getElementById('refreshBtn').addEventListener('click', fetchAllData);
});

function handleLogin(e) {
    e.preventDefault();
    if (document.getElementById('passwordInput').value === VALID_PASSWORD) {
        sessionStorage.setItem('villaLoggedIn', 'true');
        showMainContent();
    } else {
        document.getElementById('loginError').classList.add('show');
        setTimeout(() => document.getElementById('loginError').classList.remove('show'), 3000);
    }
}

function showMainContent() {
    document.getElementById('loginOverlay').classList.add('hidden');
    document.getElementById('mainContent').classList.add('visible');
    fetchAllData();
}

function logout() {
    sessionStorage.removeItem('villaLoggedIn');
    location.reload();
}

function openSheet() {
    window.open(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/edit`, '_blank');
}

async function fetchAllData() {
    showLoading(true);
    try {
        await Promise.all([fetchRenovationData(), fetchACData()]);
        updateRenovationView();
        updateACView();
        showToast('Data loaded successfully', 'success');
    } catch (e) {
        console.error(e);
        showToast('Error loading data', 'error');
    } finally {
        showLoading(false);
    }
}

async function fetchRenovationData() {
    try {
        const res = await fetch(RENOVATION_URL);
        const text = await res.text();
        const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
        renovationData = json.table.rows.map((row, i) => {
            const c = row.c;
            return {
                id: i,
                villaNo: getVal(c, 0),
                status: getVal(c, 1),
                dateRenovated: getVal(c, 2),
                remarks: getVal(c, 3),
                cost: parseFloat(String(getVal(c, 4)).replace(/[^0-9.-]/g, '')) || 0,
                startDate: getVal(c, 5),
                endDate: getVal(c, 6)
            };
        }).filter(r => r.villaNo && !String(r.villaNo).toLowerCase().includes('villa no'));
    } catch (e) {
        console.error('Renovation data fetch error:', e);
    }
}

async function fetchACData() {
    try {
        const res = await fetch(AC_URL);
        const text = await res.text();
        const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
        acData = json.table.rows.map((row, i) => {
            const c = row.c;
            return {
                id: i,
                villaNo: getVal(c, 0),
                // Reading as text
                lvr: getVal(c, 1),
                sitting: getVal(c, 2),
                office: getVal(c, 3),
                mbr1: getVal(c, 4),
                mbr2: getVal(c, 5),
                mbr3: getVal(c, 6),
                kids: getVal(c, 7),
                guest: getVal(c, 8),
                kitchen: getVal(c, 9),
                sq: getVal(c, 10),
                store: getVal(c, 11),
                patio: getVal(c, 12)
            };
        }).filter(r => r.villaNo && !String(r.villaNo).toLowerCase().includes('villa'));
        
        if (acData.length === 0) {
            showToast('Warning: No AC Data found.', 'error');
        }

    } catch (e) {
        console.error('AC data fetch error:', e);
        showToast('Error fetching AC Data. Check URL.', 'error');
    }
}

function getVal(cells, i) {
    if (!cells || !cells[i]) return '';
    const c = cells[i];
    return c.f || c.v || '';
}

// Renovation Filter Function
function filterRenovation(type) {
    currentFilter = type;
    
    // Highlight the active card
    document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active-filter'));
    if(type === 'all') document.querySelector('.stat-card.total').classList.add('active-filter');
    if(type === 'full') document.querySelector('.stat-card.renovated').classList.add('active-filter');
    if(type === 'half') document.querySelector('.stat-card.half-renovated').classList.add('active-filter');
    if(type === 'progress') document.querySelector('.stat-card.in-progress').classList.add('active-filter');
    if(type === 'non') document.querySelector('.stat-card.non-renovated').classList.add('active-filter');

    renderRenovationTable();
    renderRenovationCards();
}

// AC Filter Function
function filterAC(type) {
    currentACFilter = type;
    
    // Highlight the active card in AC Tab
    document.querySelectorAll('#acTab .stat-card').forEach(c => c.classList.remove('active-filter'));
    if(type === 'all') document.querySelector('#acTab .stat-card.total').classList.add('active-filter');
    if(type === 'new') document.querySelector('#acTab .stat-card.new-ac').classList.add('active-filter');
    if(type === 'old') document.querySelector('#acTab .stat-card.old-ac').classList.add('active-filter');

    renderACTable();
    renderACCards();
}

// Search Function
function handleSearch() {
    const query = document.getElementById('searchInput').value.toLowerCase();
    
    // Search Renovation Table
    const renRows = document.querySelectorAll('#renovationTable tr');
    renRows.forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(query) ? '' : 'none';
    });

    // Search Renovation Cards
    const renCards = document.querySelectorAll('#villaCards .villa-card');
    renCards.forEach(card => {
        const text = card.innerText.toLowerCase();
        card.style.display = text.includes(query) ? 'block' : 'none';
    });

    // Search AC Table
    const acRows = document.querySelectorAll('#acTable tr');
    acRows.forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(query) ? '' : 'none';
    });

    // Search AC Cards
    const acCards = document.querySelectorAll('#acCards .ac-card');
    acCards.forEach(card => {
        const text = card.innerText.toLowerCase();
        card.style.display = text.includes(query) ? 'block' : 'none';
    });
}

function updateRenovationView() {
    const full = renovationData.filter(i => isFullRenovated(i.status)).length;
    const half = renovationData.filter(i => isHalfRenovated(i.status)).length;
    const prog = renovationData.filter(i => isInProgress(i.status)).length;
    const non = renovationData.filter(i => isNonRenovated(i.status)).length;
    // Calculation removed as progress bar is removed
    
    document.getElementById('totalVillas').textContent = renovationData.length;
    document.getElementById('fullRenovated').textContent = full;
    document.getElementById('halfRenovated').textContent = half;
    document.getElementById('inProgress').textContent = prog;
    document.getElementById('nonRenovated').textContent = non;
    
    renderRenovationTable();
    renderRenovationCards();
}

function renderRenovationTable() {
    const tbody = document.getElementById('renovationTable');
    
    // Apply Filter
    let dataToShow = renovationData;
    if (currentFilter === 'full') dataToShow = renovationData.filter(i => isFullRenovated(i.status));
    else if (currentFilter === 'half') dataToShow = renovationData.filter(i => isHalfRenovated(i.status));
    else if (currentFilter === 'progress') dataToShow = renovationData.filter(i => isInProgress(i.status));
    else if (currentFilter === 'non') dataToShow = renovationData.filter(i => isNonRenovated(i.status));

    if(dataToShow.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding: 20px;">No data found for this filter.</td></tr>`;
        return;
    }

    tbody.innerHTML = dataToShow.map(i => `
        <tr>
            <td>Villa ${i.villaNo}</td>
            <td><span class="status-badge ${getStatusClass(i.status)}">${i.status || 'N/A'}</span></td>
            <td style="color: var(--cost); font-weight: 600;">${i.cost.toLocaleString()}</td>
            <td>${calcDuration(i.startDate, i.endDate) || '-'} days</td>
            <td>${i.dateRenovated || '-'}</td>
            <td>${i.remarks || '-'}</td>
        </tr>
    `).join('');
}

function renderRenovationCards() {
    const cards = document.getElementById('villaCards');

    // Apply Filter
    let dataToShow = renovationData;
    if (currentFilter === 'full') dataToShow = renovationData.filter(i => isFullRenovated(i.status));
    else if (currentFilter === 'half') dataToShow = renovationData.filter(i => isHalfRenovated(i.status));
    else if (currentFilter === 'progress') dataToShow = renovationData.filter(i => isInProgress(i.status));
    else if (currentFilter === 'non') dataToShow = renovationData.filter(i => isNonRenovated(i.status));

    if(dataToShow.length === 0) {
        cards.innerHTML = `<p style="grid-column: 1/-1; text-align:center; padding:20px; color:var(--gray);">No data found for this filter.</p>`;
        return;
    }

    cards.innerHTML = dataToShow.map(i => {
        const dur = calcDuration(i.startDate, i.endDate);
        return `<div class="villa-card">
            <div class="villa-card-header ${getHeaderClass(i.status)}">
                <h3><i class="fas fa-home"></i> Villa ${i.villaNo}</h3>
            </div>
            <div class="villa-card-body">
                <div class="info-row">
                    <span class="label"><i class="fas fa-info-circle"></i> Status</span>
                    <span class="value">${i.status || 'N/A'}</span>
                </div>
                <div class="info-row">
                    <span class="label"><i class="fas fa-coins"></i> Cost</span>
                    <span class="value cost">${i.cost.toLocaleString()}</span>
                </div>
                <div class="info-row">
                    <span class="label"><i class="fas fa-clock"></i> Duration</span>
                    <span class="value">${dur !== null ? dur + ' days' : '-'}</span>
                </div>
                <div class="info-row">
                    <span class="label"><i class="fas fa-calendar"></i> Date</span>
                    <span class="value">${i.dateRenovated || '-'}</span>
                </div>
            </div>
        </div>`;
    }).join('');
}

function updateACView() {
    let totalACs = 0;
    let newACs = 0;
    let oldACs = 0;

    acData.forEach(villa => {
        const rooms = [villa.lvr, villa.sitting, villa.office, villa.mbr1, villa.mbr2, villa.mbr3, villa.kids, villa.guest, villa.kitchen, villa.sq, villa.store, villa.patio];
        
        rooms.forEach(status => {
            const s = String(status).toLowerCase().trim();
            if (s) {
                totalACs++;
                if (s === 'new') newACs++;
                if (s === 'old') oldACs++;
            }
        });
    });

    document.getElementById('totalACs').textContent = totalACs;
    document.getElementById('totalNewACs').textContent = newACs;
    document.getElementById('totalOldACs').textContent = oldACs;
    document.getElementById('villasWithAC').textContent = acData.length;
    
    renderACTable();
    renderACCards();
}

function renderACTable() {
    const tbody = document.getElementById('acTable');
    
    // Filter Rows: Only show villas that have selected filter type
    let rowsToShow = acData;
    if (currentACFilter !== 'all') {
        rowsToShow = acData.filter(villa => {
            const rooms = [villa.lvr, villa.sitting, villa.office, villa.mbr1, villa.mbr2, villa.mbr3, villa.kids, villa.guest, villa.kitchen, villa.sq, villa.store, villa.patio];
            return rooms.some(r => String(r).toLowerCase().trim() === currentACFilter);
        });
    }
    
    if(rowsToShow.length === 0) {
        tbody.innerHTML = `<tr><td colspan="13" style="text-align:center; padding: 20px;">No data found for this filter.</td></tr>`;
        return;
    }

    tbody.innerHTML = rowsToShow.map(i => `
        <tr>
            <td>Villa ${i.villaNo}</td>
            ${renderACCell(i.lvr)}
            ${renderACCell(i.sitting)}
            ${renderACCell(i.office)}
            ${renderACCell(i.mbr1)}
            ${renderACCell(i.mbr2)}
            ${renderACCell(i.mbr3)}
            ${renderACCell(i.kids)}
            ${renderACCell(i.guest)}
            ${renderACCell(i.kitchen)}
            ${renderACCell(i.sq)}
            ${renderACCell(i.store)}
            ${renderACCell(i.patio)}
        </tr>
    `).join('');
}

function renderACCell(val) {
    if(!val) return `<td style="text-align:center; color:#ccc;">-</td>`;
    const s = String(val).toLowerCase();
    let style = '';
    let fontWeight = '';
    
    // Visual Highlighting for Filter
    if (currentACFilter !== 'all') {
        if (s === currentACFilter) {
            style = 'font-weight: 900; font-size: 1.1rem; transform: scale(1.1);';
        } else {
            style = 'opacity: 0.2;'; // Dim non-matching cells
        }
    }
    
    const cls = s === 'new' ? 'ac-badge-new' : (s === 'old' ? 'ac-badge-old' : '');
    return `<td style="text-align:center; ${style}"><span class="${cls}">${val}</span></td>`;
}

function renderACCards() {
    const cards = document.getElementById('acCards');
    
    // Filter Cards
    let cardsToShow = acData;
    if (currentACFilter !== 'all') {
        cardsToShow = acData.filter(villa => {
            const rooms = [villa.lvr, villa.sitting, villa.office, villa.mbr1, villa.mbr2, villa.mbr3, villa.kids, villa.guest, villa.kitchen, villa.sq, villa.store, villa.patio];
            return rooms.some(r => String(r).toLowerCase().trim() === currentACFilter);
        });
    }
    
    if(cardsToShow.length === 0) {
        cards.innerHTML = `<p style="grid-column: 1/-1; text-align:center; padding:20px; color:var(--gray);">No data found for this filter.</p>`;
        return;
    }

    cards.innerHTML = cardsToShow.map(i => `
        <div class="ac-card">
            <div class="ac-card-header">
                <h3><i class="fas fa-wind"></i> Villa ${i.villaNo}</h3>
            </div>
            <div class="ac-card-body">
                <div class="ac-room-grid">
                    ${renderACRoomCard('LVR', i.lvr)}
                    ${renderACRoomCard('Sitting', i.sitting)}
                    ${renderACRoomCard('Office', i.office)}
                    ${renderACRoomCard('MBR 1', i.mbr1)}
                    ${renderACRoomCard('MBR 2', i.mbr2)}
                    ${renderACRoomCard('MBR 3', i.mbr3)}
                    ${renderACRoomCard('Kids', i.kids)}
                    ${renderACRoomCard('Guest', i.guest)}
                    ${renderACRoomCard('Kitchen', i.kitchen)}
                    ${renderACRoomCard('SQ', i.sq)}
                    ${renderACRoomCard('Store', i.store)}
                    ${renderACRoomCard('Patio', i.patio)}
                </div>
            </div>
        </div>
    `).join('');
}

function renderACRoomCard(name, val) {
    if(!val) return `<div class="ac-room-item" style="opacity:0.5"><div class="room-name">${name}</div><div class="room-qty">-</div></div>`;
    const s = String(val).toLowerCase();
    
    let style = '';
    if (currentACFilter !== 'all') {
        if (s === currentACFilter) {
            style = 'font-weight: 900; font-size: 1.2rem; transform: scale(1.1);';
        } else {
            style = 'opacity: 0.2;';
        }
    }
    
    const color = s === 'new' ? 'var(--success)' : (s === 'old' ? 'var(--warning)' : 'var(--info)');
    return `<div class="ac-room-item" style="${style}"><div class="room-name">${name}</div><div class="room-qty" style="color:${color}">${val}</div></div>`;
}

function isFullRenovated(s) {
    if (!s) return false;
    const x = String(s).toLowerCase();
    return !x.includes('non') && !x.includes('half') && !x.includes('under') && (x.includes('full') || x.includes('renovated'));
}

function isHalfRenovated(s) {
    return s && String(s).toLowerCase().includes('half');
}

function isInProgress(s) {
    if (!s) return false;
    const x = String(s).toLowerCase();
    return !x.includes('half') && (x.includes('under') || x.includes('progress'));
}

function isNonRenovated(s) {
    return !isFullRenovated(s) && !isHalfRenovated(s) && !isInProgress(s);
}

function getStatusClass(s) {
    if (isHalfRenovated(s)) return 'status-half-renovated';
    if (isInProgress(s)) return 'status-in-progress';
    if (isFullRenovated(s)) return 'status-full-renovated';
    return 'status-non-renovated';
}

function getHeaderClass(s) {
    if (isHalfRenovated(s)) return 'half-renovated';
    if (isInProgress(s)) return 'in-progress';
    if (isFullRenovated(s)) return 'full-renovated';
    return 'non-renovated';
}

function calcDuration(start, end) {
    if (!start) return null;
    const s = new Date(start);
    const e = end ? new Date(end) : new Date();
    if (isNaN(s)) return null;
    return Math.max(0, Math.ceil((e - s) / (1000 * 60 * 60 * 24)));
}

function switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    if (tab === 'renovation') {
        document.querySelectorAll('.tab-btn')[0].classList.add('active');
        document.getElementById('renovationTab').classList.add('active');
    } else {
        document.querySelectorAll('.tab-btn')[1].classList.add('active');
        document.getElementById('acTab').classList.add('active');
    }
}

function switchView(view) {
    const btns = document.querySelectorAll('#renovationTab .view-btn');
    btns.forEach(b => b.classList.remove('active'));
    document.getElementById('tableView').classList.remove('active');
    document.getElementById('cardsView').classList.remove('active');
    
    if (view === 'table') {
        btns[0].classList.add('active');
        document.getElementById('tableView').classList.add('active');
    } else {
        btns[1].classList.add('active');
        document.getElementById('cardsView').classList.add('active');
    }
}

function switchACView(view) {
    const btns = document.querySelectorAll('#acTab .view-btn');
    btns.forEach(b => b.classList.remove('active'));
    document.getElementById('acTableView').classList.remove('active');
    document.getElementById('acCardsView').classList.remove('active');
    
    if (view === 'table') {
        btns[0].classList.add('active');
        document.getElementById('acTableView').classList.add('active');
    } else {
        btns[1].classList.add('active');
        document.getElementById('acCardsView').classList.add('active');
    }
}

function exportData() {
    // Always export ALL data, not filtered
    const ws1 = XLSX.utils.json_to_sheet(renovationData.map(i => ({
        'Villa': i.villaNo,
        'Status': i.status,
        'Cost': i.cost,
        'Start': i.startDate,
        'End': i.endDate,
        'Remarks': i.remarks
    })));
    
    const ws2 = XLSX.utils.json_to_sheet(acData.map(i => ({
        'Villa': i.villaNo,
        'LVR': i.lvr,
        'Sitting': i.sitting,
        'Office': i.office,
        'MBR1': i.mbr1,
        'MBR2': i.mbr2,
        'MBR3': i.mbr3,
        'Kids': i.kids,
        'Guest': i.guest,
        'Kitchen': i.kitchen,
        'SQ': i.sq,
        'Store': i.store,
        'Patio': i.patio
    })));
    
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws1, 'Renovation');
    XLSX.utils.book_append_sheet(wb, ws2, 'AC Replacement');
    XLSX.writeFile(wb, `Villa_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
    showToast('Exported successfully', 'success');
}

function showLoading(show) {
    document.getElementById('loadingOverlay').classList.toggle('hidden', !show);
}

function showToast(msg, type = 'success') {
    const toast = document.getElementById('toast');
    document.getElementById('toastMessage').textContent = msg;
    toast.className = `toast ${type} show`;
    setTimeout(() => toast.classList.remove('show'), 3000);
}

window.switchTab = switchTab;
window.switchView = switchView;
window.switchACView = switchACView;
window.logout = logout;
window.exportData = exportData;
window.filterRenovation = filterRenovation;
window.filterAC = filterAC;
window.handleSearch = handleSearch;
window.openSheet = openSheet;
</script>
</body>
</html>
